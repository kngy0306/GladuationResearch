%zï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É•Xï¿½Ìï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ælï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÌƒVï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½
clear
tic; %ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½Ô‘ï¿½ï¿½ï¿½

%--------------------------------ï¿½eï¿½Lï¿½Xï¿½gï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½Ì“Ç‚İï¿½ï¿½ï¿½----------------------------
%780nmï¿½ï¿½ï¿½ï¿½380nmï¿½Ü‚Å‚Ìï¿½ï¿½lï¿½ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½eï¿½Lï¿½Xï¿½gï¿½tï¿½@ï¿½Cï¿½ï¿½
x1=load('x-lambda.txt');
y1=load('y-lambda.txt');
z1=load('z-lambda.txt');
S=load('D65.txt');
%----------ï¿½oï¿½Í‰æ‘œï¿½ï¿½----------
height= 50;
width = 360;
result_all=zeros(height,width,3); % ï¿½ï¿½ï¿½Ê‚ï¿½ï¿½\ï¿½ï¿½ï¿½æ‘œï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½  (ï¿½c,ï¿½ï¿½,RGB)ï¿½Ì}ï¿½ÌƒTï¿½Cï¿½Y
result2=zeros(height,width,3); 

%-------------ï¿½ÎŒï¿½ï¿½Â‚Ìİ’ï¿½---------------
rP = [0 pi/2 pi 0 0 0 0 0 0 0];% ï¿½ÎŒï¿½ï¿½Â‚ÌŠpï¿½x(10ï¿½ï¿½ï¿½ï¿½
p=[cos(rP(1))^2 sin(rP(1))*cos(rP(1));sin(rP(1))*cos(rP(1)) sin(rP(1))^2];% ï¿½ÎŒï¿½ï¿½Â‚Ìsï¿½ï¿½ï¿½vï¿½Z
p2=[cos(rP(2))^2 sin(rP(2))*cos(rP(2));sin(rP(2))*cos(rP(2)) sin(rP(2))^2];% ï¿½ÎŒï¿½ï¿½Â‚Ìsï¿½ï¿½ï¿½vï¿½Z

%-------------ï¿½Ê‘ï¿½ï¿½ï¿½ï¿½tï¿½Bï¿½ï¿½ï¿½ï¿½ï¿½Ìİ’ï¿½-----------------
rB=[pi/4 pi*3/4 0 0 0 0 0 0 0 0];% ï¿½ï¿½ï¿½ï¿½ï¿½Üï¿½ï¿½Ş—ï¿½ï¿½ÌŠpï¿½x(10ï¿½ï¿½)

Ba1=[cos(rB(1)) -sin(rB(1));sin(rB(1)) cos(rB(1))];% ï¿½ï¿½ï¿½ï¿½ï¿½Üï¿½ï¿½Ş—ï¿½ï¿½Ì‰ï¿½ï¿½]ï¿½vï¿½Z
Ba2=[cos(rB(2)) -sin(rB(2));sin(rB(2)) cos(rB(2))];% ï¿½ï¿½ï¿½ï¿½ï¿½Üï¿½ï¿½Ş—ï¿½ï¿½Ì‰ï¿½ï¿½]ï¿½vï¿½Z
Ba3=[cos(rB(3)) -sin(rB(3));sin(rB(3)) cos(rB(3))];% ï¿½ï¿½ï¿½ï¿½ï¿½Üï¿½ï¿½Ş—ï¿½ï¿½Ì‰ï¿½ï¿½]ï¿½vï¿½ZR

%----------ï¿½Ï‘ï¿½ï¿½ï¿½ï¿½ï¿½------------------%
angle_a = 53;         %ï¿½ï¿½ï¿½ËŠp(ï¿½uï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½Xï¿½^ï¿½[ï¿½p:53.1ï¿½ï¿½)
ice_thick = 500000; %ï¿½Xï¿½ÌŒï¿½ï¿½ï¿½[nm]
%ï¿½ï¿½ï¿½Ë•ï¿½ï¿½ï¿½(ï¿½ï¿½ï¿½Ü—ï¿½a->ï¿½ï¿½ï¿½Ü—ï¿½b)
%ï¿½Xï¿½Ì‹ï¿½ï¿½Ü—ï¿½(1.309,1.313)
n_air = 1;              %ï¿½ï¿½ï¿½Cï¿½Ì‹ï¿½ï¿½Ü—ï¿½(1)
n_x = 1.309;            %ï¿½ï¿½ï¿½Ë–Ê‚Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì‹ï¿½ï¿½Ü—ï¿½ xï¿½ï¿½
n_y = 1.313;            %yï¿½ï¿½
n_z = 1.309;            %zï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü—ï¿½(cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½)(1.313)
n_water = 1.333;        %ï¿½ï¿½ï¿½Ì‹ï¿½ï¿½Ü—ï¿½(1.333)

%----------ï¿½vï¿½Z----------------------%
rad_a = deg2rad(angle_a);                   %ï¿½ï¿½ï¿½ËŠp(ï¿½ï¿½ï¿½Wï¿½Aï¿½ï¿½)
rad_b = asin( sin(rad_a) * (n_air/n_y) );     %ï¿½oï¿½ËŠp(ï¿½ï¿½ï¿½Wï¿½Aï¿½ï¿½)
angle_b = rad2deg(rad_b);   %ï¿½oï¿½ËŠp(ï¿½ï¿½ï¿½ÜŠp)(ï¿½uï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½Xï¿½^ï¿½[ï¿½p:37.5ï¿½ï¿½)
n = n_y * n_z / (sqrt(n_y.^2 * sin(rad_b).^2 + n_z.^2 * cos(rad_b).^2)); %ï¿½ï¿½ï¿½ËŠpï¿½ï¿½ï¿½Ü—ï¿½
a_dig = rad2deg(asin(sin(deg2rad(angle_a))/n_x));

rs_a2i = Rs(angle_a,n_air,n_x);
rp_a2i = Rp(angle_a,n_air,n_x);

rs_i2a = Rs(a_dig,n_x,n_air);
rp_i2a = Rp(a_dig,n_x,n_air);

rs_a2w = Rs(angle_a,n_air,n_water);
rp_a2w = Rp(angle_a,n_air,n_water);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                            %
% ã“ã“ã«æ¹–åº•åå°„ã‚’åŠ ãˆã¦ã‚‚ã‚ã‚Š  %
%                                            %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

sum_rps = rs_a2i+rp_a2i+rs_i2a+rp_i2a+rs_a2w+rp_a2w;

%percentage = rs / (rs + rp);   %sï¿½ÎŒï¿½ï¿½ÌŠï¿½ï¿½ï¿½

%----------ï¿½ï¿½ï¿½^ï¿½ï¿½ ï¿½ï¿½ xyz ï¿½ï¿½ xy,rgb ----------

ice = abs((n - n_x) * (ice_thick / cos(rad_b)));

% Xï¿½`Z ï¿½ÎŒï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½oï¿½ËŒï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
X  = 0;
Y  = 0;
Z  = 0;
X2 = 0;
Y2 = 0;
Z2 = 0;
kd = 0;
I  = zeros(81,1);
I2 = zeros(81,1);

for ri = 1:360;
    
    X  = 0;
    Y  = 0;
    Z  = 0;
    X2 = 0;
    Y2 = 0;
    Z2 = 0;
   
    kd = 0;
    
    for t = 1:81% MATLABï¿½Ì“Yï¿½ï¿½ï¿½ï¿½ï¿½ï¿½1ï¿½ï¿½ï¿½ï¿½ï¿½È‚Ì‚ÅAï¿½ï¿½ï¿½Ì‚æ‚¤ï¿½É‚ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½
        w = t*5+375;%ï¿½gï¿½ï¿½380ï¿½`780nmï¿½Ü‚ï¿½(ï¿½Âï¿½ï¿½ï¿½ï¿½ï¿½5[nm]ï¿½ï¿½ï¿½Â’ï¿½ï¿½×‚ï¿½)
        
        F=[1 0;0 1]; 
        F_ice=[exp(-1i*pi*ice/w) 0;0 exp(1i*pi*ice/w)]; %ï¿½Xï¿½Ì”gï¿½ï¿½ï¿½ï¿½ï¿½Æ‚Ìsï¿½ï¿½ï¿½vï¿½Z
        P=[cos(pi*(ri-1)/180)^2 sin(pi*(ri-1)/180)*cos(pi*(ri-1)/180);sin(pi*(ri-1)/180)*cos(pi*(ri-1)/180) sin(pi*(ri-1)/180)^2];% ï¿½ÎŒï¿½ï¿½Â‚Ìsï¿½ï¿½ï¿½vï¿½Z
        
        %aï¿½`jï¿½Ü‚Ågï¿½ï¿½ï¿½Ì‚ğ“¯‚ï¿½ï¿½æ‚¤ï¿½Éï¿½ï¿½ï¿½
        %E=P1 *Ba1*F*Ba2 *Bb1*F4*Bb2 *Bc1*F*Bc2 *Bd1*F4*Bd2 *P2; %ï¿½oï¿½ËŒï¿½ï¿½ï¿½ï¿½xï¿½ÌŒvï¿½Z,ï¿½Wï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Yï¿½}ï¿½gï¿½ï¿½ï¿½bï¿½Nï¿½X
        E_i = P * F * [1; 0];
        E2_i = P * F * [0; 1];
        E_a = P * (Ba1*F_ice*Ba1') * [1; 0];
        E2_a = P * (Ba1*F_ice*Ba1') * [0; 1];
        E_w = P * (Ba1*F_ice*Ba1') * [1; 0];
        E2_w = P * (Ba1*F_ice*Ba1') * [0; 1];
        
        I(t,1) =sum((rs_a2i/sum_rps) * abs(E_i(:).^2) +(rp_a2i/sum_rps) * abs(E2_i(:).^2)+(rs_i2a/sum_rps) * abs(E_a(:).^2) +(rp_i2a/sum_rps) * abs(E2_a(:).^2)+(rs_a2w/sum_rps) * abs(E_w(:).^2) +(rp_a2w/sum_rps) * abs(E2_w(:).^2));
      
        X=X+(S(t,1)*I(t,1)*x1(t,1));
        Y=Y+(S(t,1)*I(t,1)*y1(t,1)); % Y numerator ï¿½ï¿½ï¿½qï¿½ÌÏ•ï¿½ï¿½ÌŒvï¿½Z
        Z=Z+(S(t,1)*I(t,1)*z1(t,1)); % Z numerator ï¿½ï¿½ï¿½qï¿½ÌÏ•ï¿½ï¿½ÌŒvï¿½Z
        
        kd=kd+(S(t,1)*y1(t,1));% k denominator ï¿½ï¿½ï¿½ï¿½ï¿½ÌÏ•ï¿½ï¿½ÌŒvï¿½Z 100ï¿½ÍŒï¿½ï¿½Åï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì‚Å–ï¿½ï¿½ï¿½

    end

    X = X/kd;
    Y = Y/kd;
    Z = Z/kd;
    
    %kdï¿½ÅŠï¿½ï¿½ï¿½ï¿½Ä•Û‘ï¿½
    xy(ri,1)=X/(X+Y+Z);% xï¿½ï¿½ï¿½W
    xy(ri,2)=Y/(X+Y+Z);% yï¿½ï¿½ï¿½W

    %----------XYZï¿½ï¿½ï¿½Wï¿½ï¿½RGBï¿½ÏŠï¿½----------
    % CIE XYZï¿½nï¿½ï¿½ï¿½ï¿½CIE RGBï¿½nï¿½Ö‚Ì•ÏŠï¿½
    R =    2.3655*X +  (-0.8971)*Y +  (-0.4683)*Z;
    G = (-0.5151)*X +     1.4264*Y +     0.0887*Z;
    B =    0.0052*X +  (-0.0144)*Y +     1.0089*Z;
    
    R = max(R,0.0);
    G = max(G,0.0);
    B = max(B,0.0);

    %----------ï¿½ï¿½ï¿½ÂF----------
    result_all(:,ri,1)=R; % Rï¿½Ì’l
    result_all(:,ri,2)=G; % Gï¿½Ì’l
    result_all(:,ri,3)=B;% Bï¿½Ì’l
end

%----------ï¿½æ‘œï¿½Û‘ï¿½----------
imwrite(result_all, ['./result_reflect_all/',num2str(ice_thick/1000000),'mm_',num2str(angle_a),'.png']);
imshow(result_all);

toc; %ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½Ô‘ï¿½ï¿½ï¿½
%**********END**********